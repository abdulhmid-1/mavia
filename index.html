<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      direction: rtl;
      background-image: url('background.jpg');
      background-size: cover;
      background-position: center;
      color: #fff;
    }
    .overlay {
      background-color: rgba(0,0,0,0.7);
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
    }
    button {
      background-color: #2196F3;
      color: white;
    }
    button:hover {
      background-color: #0b7dda;
    }
    #roleImage {
      width: 150px;
      height:150px;
      margin:10px auto;
    }
    #scrollingSignature {
      position:static;
      bottom: 0;
      width: 100%;
      background-color: rgba(0,0,0,0.5);
      color: white;
      font-size: 20px;
      padding: 5px 0;
    }
    #sleepTimer {
      font-size: 24px;
      color: yellow;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  <h1>ğŸ­ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§!</h1>
  <button onclick="clearStorage()">ğŸ—‘ï¸ ØªØµÙÙŠØ± ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  <button id="reviewAfterReloadBtn" style="display:none" onclick="reviewAfterReload()">ğŸ“œ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button>

  <div id="playerInputSection">
    <input type="text" id="playerNameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
    <button onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ©</button>
    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: <span id="playerCount">0</span></p>
    <button onclick="startGame()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    <ul id="playerList"></ul>
  </div>

  <div id="gameSection" style="display:none">
    <h2 id="instruction">Ø³Ù„Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ</h2>
    <p id="currentPlayerName"></p>
    <div id="beforeReveal">
      <button onclick="revealRole()">Ø¹Ø±Ø¶ Ø¯ÙˆØ±ÙŠ</button>
    </div>
    <div id="roleSection" style="display:none">
      <img id="roleImage" src="/icon-192.png">
      <p id="currentRole"></p>
      <button onclick="nextPlayer()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>

  <div id="resetSection" style="display:none">
    <h2>ğŸ‰ ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±!</h2>
    <button onclick="resetGame()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨ (Ø¨Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¬Ø¯Ø¯)</button>
    <button onclick="restartSamePlayers()">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button>
    <button onclick="reviewRoles()">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</button>
    <div id="sleepTimer"></div>
  </div>

  <div id="reviewSection" style="display:none">
    <h2>ğŸ“‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</h2>
    <ul id="reviewList"></ul>
    <button onclick="closeReview()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
  </div>

  <div id="scrollingSignature">ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯ ØµÙ„Ø§Ø­ ENG: Abdulhamid Salah</div>

  <!-- Ø§Ù„Ø£ØµÙˆØ§Øª -->
  <audio id="roleSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="doneSound" src="https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg" preload="auto"></audio>
  <audio id="sleepSound" src="sleep.mp3" preload="auto"></audio>
  <audio id="mafiaWakeupSound" src="mafia.mp3" preload="auto"></audio>

  <script>
    let players = JSON.parse(localStorage.getItem("players")) || [];
    let roles = JSON.parse(localStorage.getItem("roles")) || [];
    let currentPlayerIndex = 0;
    let sleepTimerInterval;

    function clearStorage() {
      localStorage.clear();
      location.reload();
    }

    function addPlayer() {
      const input = document.getElementById("playerNameInput");
      const name = input.value.trim();
      if (name) {
        players.push(name);
        document.getElementById("playerList").innerHTML += `<li>${name}</li>`;
        document.getElementById("playerCount").textContent = players.length;
        input.value = "";
        input.focus();
        localStorage.setItem("players", JSON.stringify(players));
      }
    }

    document.getElementById("playerNameInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") addPlayer();
    });

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateRoles() {
      roles = Array(players.length).fill("Ù…ÙˆØ·Ù† ØµØ§Ù„Ø­");
      roles[0] = "Ø´ÙŠØ®";
      roles[1] = "Ù…Ø§ÙÙŠØ§";
      roles[2] = "Ù…Ø§ÙÙŠØ§";
      shuffle(roles);
      localStorage.setItem("roles", JSON.stringify(roles));
    }

    function startGame() {
      if (players.length < 7) {
        alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† 7 Ø£Ùˆ Ø£ÙƒØ«Ø±!");
        return;
      }
      currentPlayerIndex = 0;
      generateRoles();
      shuffle(players);
      document.getElementById("playerInputSection").style.display = "none";
      document.getElementById("gameSection").style.display = "block";
      showCurrentPlayerName();
    }

    function showCurrentPlayerName() {
      if (currentPlayerIndex >= players.length) {
        document.getElementById("gameSection").style.display = "none";
        document.getElementById("resetSection").style.display = "block";
        document.getElementById("doneSound").play();
        playSleepSound();
        return;
      }
      const name = players[currentPlayerIndex];
      document.getElementById("instruction").textContent = `Ø³Ù„Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨: ${name}`;
      document.getElementById("currentPlayerName").textContent = `Ø§Ù„Ù„Ø§Ø¹Ø¨: ${name}`;
      document.getElementById("roleSection").style.display = "none";
      document.getElementById("beforeReveal").style.display = "block";
    }

    function revealRole() {
      const role = roles[currentPlayerIndex];
      const roleText = document.getElementById("currentRole");
      const roleImage = document.getElementById("roleImage");

      roleText.textContent = `Ø¯ÙˆØ±Ùƒ Ù‡Ùˆ: ${role}`;
      roleText.style.color = role === "Ù…Ø§ÙÙŠØ§" ? "red" : role === "Ø´ÙŠØ®" ? "green" : "lightblue";

      if (role === "Ù…Ø§ÙÙŠØ§") {
        roleImage.src = "mafia.jpg";
      } else if (role === "Ø´ÙŠØ®") {
        roleImage.src = "sheikh.png";
      } else {
        roleImage.src = "citizen.png";
      }
      roleImage.style.display = "block";

      document.getElementById("roleSection").style.display = "block";
      document.getElementById("beforeReveal").style.display = "none";
      const sound = document.getElementById("roleSound");
      sound.currentTime = 0;
      sound.play().catch(() => {});
    }

    function nextPlayer() {
      currentPlayerIndex++;
      showCurrentPlayerName();
    }

    function resetGame() {
      players = [];
      roles = [];
      currentPlayerIndex = 0;
      document.getElementById("playerList").innerHTML = "";
      document.getElementById("playerCount").textContent = "0";
      document.getElementById("playerNameInput").value = "";
      localStorage.removeItem("players");
      localStorage.removeItem("roles");
      document.getElementById("resetSection").style.display = "none";
      document.getElementById("gameSection").style.display = "none";
      document.getElementById("reviewSection").style.display = "none";
      document.getElementById("playerInputSection").style.display = "block";
    }

    function restartSamePlayers() {
      currentPlayerIndex = 0;
      generateRoles();
      document.getElementById("resetSection").style.display = "none";
      document.getElementById("reviewSection").style.display = "none";
      document.getElementById("gameSection").style.display = "block";
      showCurrentPlayerName();
    }

    function reviewRoles() {
      document.getElementById("resetSection").style.display = "none";
      document.getElementById("reviewSection").style.display = "block";
      const reviewList = document.getElementById("reviewList");
      reviewList.innerHTML = "";
      for (let i = 0; i < players.length; i++) {
        reviewList.innerHTML += `<li>${players[i]}: ${roles[i]}</li>`;
      }
    }

    function closeReview() {
      document.getElementById("reviewSection").style.display = "none";
      document.getElementById("resetSection").style.display = "block";
    }

    function reviewAfterReload() {
      players = JSON.parse(localStorage.getItem("players"));
      roles = JSON.parse(localStorage.getItem("roles"));
      const reviewList = document.getElementById("reviewList");
      reviewList.innerHTML = "";
      for (let i = 0; i < players.length; i++) {
        reviewList.innerHTML += `<li>${players[i]}: ${roles[i]}</li>`;
      }
      document.getElementById("reviewSection").style.display = "block";
      document.getElementById("playerInputSection").style.display = "none";
    }

    function playSleepSound() {
      const sleepAudio = document.getElementById("sleepSound");
      const mafiaAudio = document.getElementById("mafiaWakeupSound");
      const timer = document.getElementById("sleepTimer");
      let duration = 30;
      timer.style.display = "block";
      sleepAudio.loop = true;
      sleepAudio.play();

      sleepTimerInterval = setInterval(() => {
        timer.textContent = `ğŸ•’ Ø§Ù„ÙƒÙ„ ÙŠÙ†Ø§Ù…... ${duration} Ø«Ø§Ù†ÙŠØ©`;
        duration--;
        if (duration < 0) {
          clearInterval(sleepTimerInterval);
          sleepAudio.pause();
          sleepAudio.currentTime = 0;
          timer.textContent = `ğŸ•’ Ø§Ù„Ù…Ø§ÙÙŠØ§ ØªØµØ­Ù‰ ÙˆØªØªØ¹Ø§Ø±Ù... 15 Ø«Ø§Ù†ÙŠØ©`;

          // ØµÙˆØª Ø§Ù„Ù…Ø§ÙÙŠØ§
          mafiaAudio.play();
          let mafiaDuration = 15;
          const mafiaTimer = setInterval(() => {
            timer.textContent = `ğŸ•’ Ø§Ù„Ù…Ø§ÙÙŠØ§ ØªØµØ­Ù‰ ÙˆØªØªØ¹Ø§Ø±Ù... ${mafiaDuration} Ø«Ø§Ù†ÙŠØ©`;
            mafiaDuration--;
            if (mafiaDuration < 0) {
              clearInterval(mafiaTimer);
              mafiaAudio.pause();
              mafiaAudio.currentTime = 0;
              timer.style.display = "none";
            }
          }, 1000);
        }
      }, 1000);
    }

    window.onload = () => {
      if (localStorage.getItem("players") && localStorage.getItem("roles")) {
        document.getElementById("reviewAfterReloadBtn").style.display = "inline-block";
      }
      if (localStorage.getItem("players")) {
        players = JSON.parse(localStorage.getItem("players"));
        const playerList = document.getElementById("playerList");
        const playerCount = document.getElementById("playerCount");
        playerList.innerHTML = "";
        players.forEach(name => {
          playerList.innerHTML += `<li>${name}</li>`;
        });
        playerCount.textContent = players.length;
      }
    }
  </script>
</body>
</html>